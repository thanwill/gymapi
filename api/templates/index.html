<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Exibição de Dados</title>
    <!-- Bootstrap CSS via CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />

    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <style>
        .swiper {
            width: auto;
            min-height: 400px;
            max-height: 700px;
        }
    </style>

</head>

<body>

    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav" style="height: 5vh;"></div>
        </div>
    </nav>

    <div class="container mt-5" style="min-height: calc(90vh - 10vh - 5vh);">
        <div class="d-flex align-items-start">

            <div class="nav flex-column nav-pills col-10 offset-1 col-lg-3 " id="v-pills-tab" role="tablist"
                aria-orientation="vertical">

                <button class="nav-link active" id="v-pills-home-tab" data-bs-toggle="pill"
                    data-bs-target="#v-pills-home" type="button" role="tab" aria-controls="v-pills-home"
                    aria-selected="true">Datasets</button>
                <button class="nav-link" id="v-pills-profile-tab" data-bs-toggle="pill"
                    data-bs-target="#v-pills-profile" type="button" role="tab" aria-controls="v-pills-profile"
                    aria-selected="false">Analysis</button>

                <!-- Adiciona a opção Insights -->

                <button class="nav-link " id="v-pills-insights-tab" data-bs-toggle="pill"
                    data-bs-target="#v-pills-insights" type="button" role="tab" aria-controls="v-pills-insights"
                    aria-selected="false">Insights</button>

                <button class="nav-link" id="v-pills-messages-tab" data-bs-toggle="pill"
                    data-bs-target="#v-pills-messages" type="button" role="tab" aria-controls="v-pills-messages"
                    aria-selected="false">Explore</button>

                <div id="search-list" class="mt-5 mb-3">

                    <input class="form-control" list="datalistOptions" id="exampleDataList"
                        placeholder="Pesquisar definições" data-bs-toggle="popover" data-bs-placement="bottom"
                        data-bs-content="Digite para pesquisar definições disponíveis">
                    <datalist id="datalistOptions"></datalist>
                </div>

                <div id="alert-message-search"></div>

                <div class="mt-3" style="max-height: 500px; overflow-y: auto;">
                    <div id="columns-metadata-content" class="">
                        <p class="text-muted">Escolha um dataset para análise dos atributos.</p>
                    </div>
                </div>

            </div>

            <div class="tab-content col-10 offset-1 col-lg-7" id="v-pills-tabContent">

                <!-- INFORMAÇÃO DO DATASETS CADASTRADOS -->
                <div class="tab-pane fade show active" id="v-pills-home" role="tabpanel"
                    aria-labelledby="v-pills-home-tab" tabindex="0">

                    <div class="col-10 offset-1">
                        <div class="mb-3 ">
                            <label for="formFile" class="form-label">
                                <h4>
                                    Cadastre um novo dataset
                                </h4>
                                <p>
                                    <small>Envie um arquivo CSV para ser processado.</small>
                                </p>
                            </label>
                            <input class="form-control mb-3" type="file" id="formFile">
                        </div>
                        <div id="alert-message-datasets"></div>
                        <div id="dataset-content" class="mt-3"></div>
                        <div id="resultados-content" class="mt-3"></div>

                    </div>

                </div>

                <!-- ANALYSES -->
                <div class="tab-pane fade" id="v-pills-profile" role="tabpanel" aria-labelledby="v-pills-profile-tab"
                    tabindex="0">
                    <div class="col-10 offset-1">

                        <h4>Selecione o dataset</h4>
                        <p>
                            <small>Selecione o dataset que deseja analisar.</small>
                        </p>
                        <div id="alert-message" class="m-3"></div>
                        <div class="form">
                            <select class="form-select" id="selec-dataset-analyses"
                                aria-label="Relação de dataset cadastrado">
                                <option selected>Selecione o seu database</option>
                            </select>
                        </div>

                        <!--<div id="filter-select" class="mt-3"></div>-->

                        <div id="target_column" class="mt-3"></div>

                        <div id="alert-message-analyses"></div>

                        <div id="datalist-options" class="m-3"></div>

                        <div id="carrosel-images" class="mt-3"></div>

                        <div class="accordion mt-4" id="accordion-analysis"></div>

                        <div id="friendly-message-container"></div>

                    </div>

                </div>

                <!-- INSIGHTS -->
                <div class="tab-pane fade " id="v-pills-insights" role="tabpanel" aria-labelledby="v-pills-insights-tab"
                    tabindex="0">

                    <div class="col-10 offset-1">
                        <h4>Insights</h4>
                        <p>
                            <small>Confira os insights gerados a partir das análises.</small>
                        </p>
                        <div class="row">
                            <div class="col mb-4">
                                <div class="input-group mb-3">
                                    <select class="form-select" id="selec-dataset-insights">
                                        <option selected>Selecione o seu database</option>
                                    </select>
                                    <button class="btn btn-outline-secondary" type="button"
                                        id="insights-types">Consultar</button>
                                </div>
                            </div>
                        </div>
                        <div id="alert-message-insights"></div>
                        <div id="chartsContainer" style="max-height: 50vh; overflow-y: auto;"></div>

                    </div>

                </div>

                <!-- EXPLORE -->
                <div class="tab-pane fade" id="v-pills-messages" role="tabpanel" aria-labelledby="v-pills-messages-tab"
                    tabindex="0">

                    <div class="col-10 offset-1">
                        <div class="alert alert-primary d-flex align-items-center" role="alert">
                            <svg xmlns="http://www.w3.org/2000/svg"
                                class="bi bi-exclamation-triangle-fill flex-shrink-0 me-4" width="24" height="24"
                                viewBox="0 0 16 16" role="img" aria-label="Warning:">
                                <path
                                    d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z" />
                            </svg>

                            <div>
                                <p>
                                    As informações fornecidas são apenas para fins educacionais e informativos.
                                    Consulte um profissional qualificado para obter orientação específica e
                                    personalizada.
                                </p>
                            </div>
                        </div>
                        <!-- Slider main container -->
                        <div class="swiper">
                            <!-- Additional required wrapper -->
                            <div class="swiper-wrapper pb-5 pt-3">
                                <!-- Slides -->
                                <div class="swiper-slide">
                                    <div class="row">

                                        <div class="col-10 offset-1 col-lg-8 offset-lg-2 p-3">

                                            <div class="text-center">
                                                <h5>Escolher o melhor exercício</h5>
                                                <p>Identifique a melhor atividade física com base em suas
                                                    características físicas atuais.</p>
                                            </div>

                                            <form id="prediction-form">
                                                <div class="mb-3">
                                                    <label for="age" class="form-label">Idade</label>
                                                    <input type="text" class="form-control" id="age" name="age"
                                                        required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="height_m" class="form-label">Altura (m)</label>
                                                    <input type="text" class="form-control" id="height_m"
                                                        name="height_m" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="gender" class="form-label">Gênero</label>
                                                    <select class="form-select" id="gender" name="gender" required>
                                                        <option value="Male">Masculino</option>
                                                        <option value="Female">Feminino</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="weight_kg" class="form-label">Peso (kg)</label>
                                                    <input type="text" class="form-control" id="weight_kg"
                                                        name="weight_kg" required>
                                                    <button type="submit"
                                                        class="btn btn-success d-block mx-auto mt-3">Prever</button>
                                            </form>
                                            <div class="card mt-3">
                                                <div class="card-body">
                                                    <h5 class="card-title text-muted">Resultado obtidos</h5>
                                                    <p class="card-text"><span id="prediction-result"></span></p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="swiper-slide"></div>
                            </div>
                            <!-- If we need pagination -->
                            <div class="swiper-pagination"></div>

                            <!-- If we need navigation buttons -->
                            <div class="swiper-button-prev"></div>
                            <div class="swiper-button-next"></div>

                            <!-- If we need scrollbar -->

                        </div>


                    </div>

                    <script>
                        const swiper = new Swiper('.swiper', {
                            // Optional parameters
                            direction: 'horizontal',
                            loop: true,

                            // If we need pagination
                            pagination: {
                                el: '.swiper-pagination',
                            },

                            // Navigation arrows
                            navigation: {
                                nextEl: '.swiper-button-next',
                                prevEl: '.swiper-button-prev',
                            },

                        });
                    </script>

                    <script>

                        // Adiciona máscara para idade
                        // Adiciona máscara para idade
                        const ageInput = document.getElementById('age');
                        ageInput.addEventListener('focus', function (event) {
                            let value = event.target.value;
                            value = value.replace(' anos', '');
                            event.target.value = value;
                        });

                        ageInput.addEventListener('blur', function (event) {
                            let value = event.target.value.replace(/[^\d]/g, ''); // Remove caracteres não numéricos
                            if (value.length > 3) {
                                value = value.slice(0, 3); // Limita a entrada a 3 dígitos
                            }
                            if (parseInt(value) > 120) {
                                value = '120'; // Limita a idade a 120 anos
                            }
                            event.target.value = value + ' anos'; // Adiciona ' anos' ao final
                        });

                        // Adiciona máscara para altura
                        const heightInput = document.getElementById('height_m');

                        // Remove ' cm' ao focar no campo
                        heightInput.addEventListener('focus', function (event) {
                            let value = event.target.value;
                            value = value.replace(' cm', '');
                            event.target.value = value;
                        });

                        // Adiciona ' cm' ao desfocar do campo
                        heightInput.addEventListener('blur', function (event) {
                            let value = event.target.value.replace(/[^\d]/g, ''); // Remove caracteres não numéricos
                            if (value.length > 0) {
                                value = value.slice(0, 1) + ',' + value.slice(1, 3); // Adiciona a vírgula após o primeiro dígito
                            }
                            event.target.value = value + ' cm'; // Adiciona ' cm' ao final
                        });

                        // Adiciona máscara para peso
                        const weightInput = document.getElementById('weight_kg');
                        weightInput.addEventListener('focus', function (event) {
                            let value = event.target.value;
                            value = value.replace(' kg', '');
                            event.target.value = value;
                        });

                        weightInput.addEventListener('blur', function (event) {
                            let value = event.target.value.replace(/[^\d]/g, ''); // Remove caracteres não numéricos
                            if (value.length > 2) {
                                value = value.slice(0, 2) + ',' + value.slice(2, 3); // Adiciona a vírgula após os dois primeiros dígitos
                            }
                            if (value.length > 4) {
                                value = value.slice(0, 4); // Limita a entrada a 4 dígitos
                            }
                            event.target.value = value + ' kg'; // Adiciona ' kg' ao final
                        });
                        

                        document.getElementById('prediction-form').addEventListener('submit', async function (event) {
                            event.preventDefault();
                            const formData = new FormData(event.target);

                            const data = Object.fromEntries(formData.entries());
                            const payload = {
                                user_data: {
                                    age: parseInt(data.age),
                                    height_m: parseFloat(data["height_m"]),
                                    gender: data.gender,
                                    weight_kg: parseFloat(data["weight_kg"])
                                }
                            };

                            try {
                                const analysisId = await getPredictionAnalysisId();
                                payload.analysis_id = analysisId;
                                payload.target_column = 'workout_type';

                                console.log('Payload:', payload);

                                const response = await fetch('http://localhost:8000/api/analyses/predict/result', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify(payload)
                                });
                                const result = await response.json();
                                document.getElementById('prediction-result').textContent = result.prediction;
                            const exerciseEmojis = {
                                Yoga: '🧘',
                                HIIT: '🏋️',
                                Cardio: '🏃',
                                Strength: '💪'
                            };

                            const predictionResult = result.prediction;
                            const emoji = exerciseEmojis[predictionResult] || '';
                            document.getElementById('prediction-result').textContent = `${predictionResult} ${emoji}`;
                            } catch (error) {
                                console.error('Error:', error);
                                document.getElementById('prediction-result').textContent = 'Error fetching prediction.';
                            }
                        });
                    </script>

                </div>
            </div>

        </div>
    </div>
    </div>

    <footer class="bg-light text-center text-lg-start mt-5">
        <div class="container p-4">
            <div class="row">
                <div class="col-lg-6 col-md-12 mb-4 mb-md-0">
                    <h5 class="text-uppercase">Sobre</h5>
                    <p>
                        Este é um projeto para exibição e análise de dados. Envie seus arquivos CSV e visualize os
                        resultados das análises.
                    </p>
                </div>

                <div class="col-lg-3 col-md-6 mb-4 mb-md-0">

                </div>
            </div>
        </div>
        <div class="text-center p-3 bg-dark text-white">
            2024 Tópicos Especiais em Software <br>
            UP - Universidade Positivo <br>
            Curutiba - PR

        </div>
    </footer>

    <!-- Bootstrap JS via CDN (incluindo Popper.js) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // funcao para retornar todos os dataset cadastrados curl --location 'http://localhost:8000/api/datasets'
        async function getDatasets() {
            const response = await fetch('http://localhost:8000/api/datasets');
            const data = await response.json();
            return data;
        }

        // curl --location 'http://localhost:8000/api/datasets/55/download'
        async function downloadDataset(id) {
            const response = await fetch(`http://localhost:8000/api/datasets/${id}/download`);
            const data = await response.json();
            return data;
        }

        // funcnao para remover um dataset pelo id curl --location --request DELETE 'http://localhost:8000/api/datasets/5/remove'
        async function removeDataset(id) {
            const response = await fetch(`http://localhost:8000/api/datasets/${id}/remove`, {
                method: 'DELETE'
            });
            let data;
            try {
                data = await response.json();
            } catch (error) {
                data = { error: 'Failed to parse JSON response' };
            }
            return data;
        }

        // função para upload de arquivo
        async function uploadFile() {
            const formData = new FormData();
            formData.append('file', document.querySelector('input[type="file"]').files[0]);
            const response = await fetch('http://localhost:8000/api/datasets/upload', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.error) {
                alerta(data.error, 'alert-danger', "alert-message-datasets");
            } else {
                alerta('Seu arquivo foi cadastrado!', 'alert-success', "alert-message-datasets");

                // chama updateDatasetOptions(dataset)
                getDatasets().then(datasets => {
                    updateDatasetOptions(datasets, "#selec-dataset-analyses");
                });

            }

            // salva no localsotrage o caminho do arquivo
            localStorage.setItem('file', data.file);

            return data;
        }

        // função curl --location 'http://localhost:8000/api/datasets/9'
        async function getDataset(id) {
            const response = await fetch(`http://localhost:8000/api/datasets/${id}`);
            const data = await response.json();
            if (data.error) {
                alerta("Não foi possível encontrar seu dataset.", 'alert-danger', "alert-message-datasets");
            } else {
                renderColumnsMetadata(data.columns_metadata);
            }
            return data;
        }

        // fetch para obter análise, passando um target_column 
        // curl --location 'http://localhost:8000/api/analyses/24?target_column=workout_frequency_(days%2Fweek)'
        async function getAnalysis(id, targetColumn) {
            console.log(targetColumn);
            const response = await fetch(`http://localhost:8000/api/analyses/${id}?target_column=${targetColumn}`);
            const data = await response.json();
            return data;
        }

        // obter curl --location 'http://localhost:8000/api/analyses'
        async function getAnalyses() {
            const response = await fetch('http://localhost:8000/api/analyses');
            const data = await response.json();
            renderAnalysesCollapse(data);
            return data;
        }

        async function carregarAnalises() {
            const analises = await getAnalyses();

            // se length for maior que 0, chama a função
            if (analises.length > 0) {
                renderAnalysesCollapse(analises);
            } else {
                alerta('Não existem análises, selecione um dataset.', 'alert-info', "alert-message-analyses");
            }
        }


        // http://localhost:8000/api/insights/types

        async function getInsights() {
            const response = await fetch('http://localhost:8000/api/insights/types');
            const data = await response.json();
            return data;
        }

        // curl --location 'http://localhost:8000/api/images/erro'
        async function getImages(arquivo) {
            const response = await fetch('http://localhost:8000/api/images/' + arquivo);
            const data = await response.json();

            if (data.error) {
                console.error(data.error);
            }

            return data;
        }

        async function createPredictionAnalysis(datasetId) {
            const payload = {
                dataset_id: datasetId,
                features: ["age", "height_(m)", "gender", "weight_(kg)"],
                target_column: "workout_type"
            };

            const response = await fetch('http://localhost:8000/api/analyses/predict/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            const data = await response.json();
            return data;
        }



        // curl de analises com até 4 filtros curl --location 'http://localhost:8000/api/analyses/filtered?analysis_type=PREDICTION&status=COMPLETED&target_column=experience_level&database_id=46'

        async function getAnalysesFiltered(database_id) {
            const response = await fetch(`http://localhost:8000/api/analyses/filtered?database_id=${database_id}`);
            const data = await response.json();

            // em caso de sucesso, renderAnalysesAccordion(analisets);
            if (data.length > 0) {
                renderAnalysesAccordion(data);
            }

            return data;
        }


        function renderAnalysesCollapse(analises) {
            const container = document.getElementById('analises-disponiveis');
            container.innerHTML = '';

            /*
                "id": 4,
                "dataset_id_id": 40,
                "analysis_type": "PREDICTION",
                "parameters": {
                    "target_column": "age"
                },
                "created_at": "2024-11-26T23:37:36.538Z",
                "status": "COMPLETED",
                "error_message": ""
            */

            analises.forEach(analise => {
                const card = document.createElement('div');
                card.classList.add('card', 'text-center', 'mb-3');

                const cardHeader = document.createElement('div');
                cardHeader.classList.add('card-header');
                cardHeader.textContent = `Análise ID: ${analise.id}`;

                const cardBody = document.createElement('div');
                cardBody.classList.add('card-body');

                const cardTitle = document.createElement('h5');
                cardTitle.classList.add('card-title');
                cardTitle.textContent = `Dataset ID: ${analise.dataset_id_id}`;

                const cardText = document.createElement('p');
                cardText.classList.add('card-text');
                cardText.textContent = `Tipo de Análise: ${analise.analysis_type}`;

                const cardLink = document.createElement('a');
                cardLink.href = '#';
                cardLink.classList.add('btn', 'btn-primary');
                cardLink.textContent = 'Ver detalhes';

                cardBody.appendChild(cardTitle);
                cardBody.appendChild(cardText);
                cardBody.appendChild(cardLink);

                const cardFooter = document.createElement('div');
                cardFooter.classList.add('card-footer', 'text-body-secondary');
                cardFooter.textContent = `Criado em: ${formatarData(analise.created_at)}`;

                card.appendChild(cardHeader);
                card.appendChild(cardBody);
                card.appendChild(cardFooter);

                container.appendChild(card);
            });
        }

        // Função para formatar a data para 'dd/mm hh:mm'
        function formatarData(dataISO) {
            const data = new Date(dataISO);
            const dia = String(data.getDate()).padStart(2, '0');
            const mes = String(data.getMonth() + 1).padStart(2, '0'); // Mês inicia em zero
            const ano = data.getFullYear();
            const hora = String(data.getHours()).padStart(2, '0');
            const minuto = String(data.getMinutes()).padStart(2, '0');
            return `${dia}/${mes}/${ano} às ${hora}:${minuto}`;
        }

        // Função para exibir o dataset de forma amigável
        function exibirDataset(dataset) {
            const container = document.getElementById('dataset-content'); // Certifique-se de que este elemento existe no seu HTML
            const html = `
                    <div class="card mb-3">
                        <div class="card-header">
                            <strong>${dataset.filename.length > 10 ? dataset.filename.substring(0, 20) + '..' : dataset.filename}.csv</strong>
                        <button class="btn btn-danger btn-sm float-end" onclick="removeDataset(${dataset.id}).then(carregarDatasets)">Excluir</button>
                        </div>
                        <div class="card-body">
                            <p>                    
                                <span class="badge text-bg-primary rounded-pill ${dataset.status === 'PROCESSED' ? 'bg-success' : 'bg-secondary'}">${dataset.status}</span>
                                <span class="ms-3">${dataset.status === 'PROCESSED' ? '✅' : '⏳'}</span>
                                <strong  >ID:</strong> ${dataset.id}
                                
                            </p>
                            <p><strong>Data de Envio:</strong> ${formatarData(dataset.uploaded_at)}</p>
                            
                            <div class="accordion" id="accordionExample">
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${dataset.id}" aria-expanded="true" aria-controls="collapse${dataset.id}">
                                            <span class="badge text-bg-primary me-3 rounded-pill">${dataset.columns.length}</span> Colunas 
                                        </button>
                                        
                                    </h2>
                                    <div id="collapse${dataset.id}" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                                        <div class="accordion-body">
                                            
                                            <ul>
                                                ${dataset.columns.map(coluna => `<li>${coluna}</li>`).join('')}
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                
    `;
            container.innerHTML += html;
        }

        async function carregarDatasets() {
            const datasets = await getDatasets();

            // reenderiza os campos de select
            updateDatasetOptions(datasets, "#selec-dataset-insights");
            updateDatasetOptions(datasets, "#selec-dataset-analyses");



            // Limpar o conteúdo anterior
            document.getElementById('dataset-content').innerHTML = '';

            // Exibir cada dataset
            if (datasets.length > 0) {
                datasets.forEach(dataset => {
                    exibirDataset(dataset);
                });
            } else {
                document.getElementById('dataset-content').innerHTML = '<p class="text-muted">Nenhum dataset encontrado.</p>';
            }
        }

        // Chamar a função para carregar e exibir os datasets        
        document.getElementById('formFile').addEventListener('change', async (event) => {
            const result = await uploadFile();
            console.log("result", result);
            if (result && result.id) {
                const data = await createPredictionAnalysis(result.id);
                console.log("data", data);
            }
            carregarDatasets();
        });

        async function getPredictionAnalysisId() {
            const response = await fetch('http://localhost:8000/api/analyses/filtered?analysis_type=PREDICTION&target_column=workout_type');
            const data = await response.json();
            if (data.length > 0) {
                return data[0].id;
            } else {
                throw new Error('No prediction analysis found.');
            }
        }



        async function updateDatasetOptions(datasets, id_select) {

            const selectElement = document.querySelector(id_select)

            selectElement.innerHTML = '<option selected>Selecione o seu dataset</option>';


            // Adicionar novas opções
            if (datasets != undefined) {
                datasets.forEach(dataset => {
                    const optionElement = document.createElement('option');
                    optionElement.value = dataset.id;
                    optionElement.textContent = `ID: ${dataset.id} - ${dataset.status}`;
                    selectElement.appendChild(optionElement);
                });
            }


        }

        // Chamar a função para carregar e exibir os datasets
        carregarDatasets().then(datasets => {
            updateDatasetOptions(datasets, "#selec-dataset-analyses");
        });

        // se #selec-dataset-analyses for carregado, chama a função
        if (document.getElementById('selec-dataset-analyses')) {
            document.getElementById('selec-dataset-analyses').addEventListener('change', async (event) => {
                const datasetId = event.target.value;
                const data = await getDataset(datasetId);
                renderColumnsMetadata(data.columns_metadata);
                //exibirFiltro(data.columns_metadata, document.getElementById('filter-select'), datasetId);
                const dados = await getAnalysesFiltered(datasetId);
            });
        }


        async function carregarOpcoesDataset() {

            const datasets = await getDatasets();

            /* carrega o primeiro dataset
            if (datasets.length > 0) {
                const data = await getDataset(datasets[0].id);
                renderFilter(data.columns_metadata);
                createCarousel(data.images);
                exibirFiltro(data.columns_metadata, document.getElementById('filter-select'), datasets[0].id);
                const dados = await getAnalysesFiltered(datasets[0].id);
                console.log(dados);
            }*/

            const selectElement = document.querySelector('select[aria-label="Relação de dataset cadastrado"]');
            if (selectElement) {
                selectElement.addEventListener('change', async (event) => {
                    const datasetId = event.target.value;
                    const data = await getDataset(datasetId);
                    renderFilter(data.columns_metadata);
                    createCarousel(data.images);
                    //exibirFiltro(data.columns_metadata, document.getElementById('filter-select'), datasetId);
                    const dados = await getAnalysesFiltered(datasetId);
                });
            }

        }

        function alerta(message, type = 'alert-warning', id_div) {
            const alertContainer = document.getElementById(id_div);
            const alert = document.createElement('div');
            alert.classList.add('alert', type, 'alert-dismissible', 'fade', 'show');
            alert.setAttribute('role', 'alert');
            alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            alertContainer.appendChild(alert);

            // Remove the alert after 3 seconds
            setTimeout(() => {
                alert.classList.remove('show');
                alert.classList.add('hide');
                setTimeout(() => {
                    alert.remove();
                }, 500); // Wait for the fade-out transition to complete
            }, 3000);
        }

        // Chamar a função para carregar e exibir as opções de datasets


        function exibirFiltro(columnsMetadata, containerElement, datasetId) {
            // Criar o contêiner do grupo de input
            const inputGroup = document.createElement('div');
            inputGroup.classList.add('input-group');

            // Criar o select para os atributos (substituindo o input)
            const selectAttributes = document.createElement('select');
            selectAttributes.classList.add('form-select');
            selectAttributes.setAttribute('aria-label', 'Selecione um atributo');

            const defaultOption = document.createElement('option');
            defaultOption.selected = true;
            defaultOption.disabled = true;
            defaultOption.textContent = 'Escolher atributo';
            selectAttributes.appendChild(defaultOption);

            // Adicionar opções dos atributos
            columnsMetadata.forEach(column => {
                const optionElement = document.createElement('option');
                optionElement.value = column.column_name;
                optionElement.textContent = column.column_name;
                optionElement.dataset.type = column.data_type; // Armazenar o tipo de dado
                selectAttributes.appendChild(optionElement);
            });

            inputGroup.appendChild(selectAttributes);

            // Botão "Buscar"
            const buttonBuscar = document.createElement('button');
            buttonBuscar.type = 'button';
            buttonBuscar.classList.add('btn', 'btn-outline-secondary');
            buttonBuscar.textContent = 'Treinar a base';
            inputGroup.appendChild(buttonBuscar);

            // Event listener para o botão "Buscar"
            buttonBuscar.addEventListener('click', async () => {
                const selectedAttribute = selectAttributes.value;
                const analysis = await getAnalysis(datasetId, selectedAttribute);

                if (analysis.error) {
                    alerta("Selecione um atributo válido.", 'alert-danger', "alert-message-analyses");
                } else {
                    setTimeout(() => {
                        showAnalysisDetails(analysis);
                    }, 1000);

                }

            });

            // Botão de dropdown para filtrar tipos
            const buttonDropdown = document.createElement('button');
            buttonDropdown.type = 'button';
            buttonDropdown.classList.add('btn', 'btn-outline-secondary', 'dropdown-toggle', 'dropdown-toggle-split');
            buttonDropdown.setAttribute('data-bs-toggle', 'dropdown');
            buttonDropdown.setAttribute('aria-expanded', 'false');
            const spanElement = document.createElement('span');
            spanElement.classList.add('visually-hidden');
            spanElement.textContent = 'Filtrar por tipo de dado';
            buttonDropdown.appendChild(spanElement);
            inputGroup.appendChild(buttonDropdown);

            // Menu dropdown
            const ulElement = document.createElement('ul');
            ulElement.classList.add('dropdown-menu', 'dropdown-menu-end');

            // Obter os tipos de data_type únicos
            const dataTypes = [...new Set(columnsMetadata.map(column => column.data_type))];

            // Criar os itens do dropdown com os data_types
            dataTypes.forEach(type => {
                const liElement = document.createElement('li');
                const aElement = document.createElement('a');
                aElement.classList.add('dropdown-item');
                aElement.textContent = type;
                aElement.addEventListener('click', () => {
                    // Filtrar opções no selectAttributes
                    for (let i = 0; i < selectAttributes.options.length; i++) {
                        const option = selectAttributes.options[i];
                        if (option.dataset.type === type || option.value === '') {
                            option.hidden = false;
                        } else {
                            option.hidden = true;
                        }
                    }
                    // Resetar a seleção
                    selectAttributes.selectedIndex = 0;
                });
                liElement.appendChild(aElement);
                ulElement.appendChild(liElement);
            });

            inputGroup.appendChild(ulElement);

            // Limpar o container e adicionar o novo input group
            containerElement.innerHTML = '';
            containerElement.appendChild(inputGroup);
        }

        function createCarousel(images) {
            if (!images || images.length === 0) {
                // Se não houver imagens, não faz nada
                return;
            }

            // Início da estrutura do carrossel
            let carouselHtml = `
                <div id="carouselExampleIndicators" class="carousel slide">
                <div class="carousel-indicators">
                `;

            // Criar os indicadores
            for (let i = 0; i < images.length; i++) {
                carouselHtml += `
                    <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="${i}" ${i === 0 ? 'class="active"' : ''} ${i === 0 ? 'aria-current="true"' : ''} aria-label="Slide ${i + 1}"></button>
                    `;
            }

            carouselHtml += `
                </div>
                <div class="carousel-inner">
                `;

            // Criar os itens do carrossel
            for (let i = 0; i < images.length; i++) {
                const image = images[i];
                const mimeType = 'image/png'; // Ajuste se necessário
                carouselHtml += `
                    <div class="carousel-item ${i === 0 ? 'active' : ''}">
                    <img src="data:${mimeType};base64,${image.data}" class="d-block w-100" alt="${image.name}">
                    <div class="carousel-caption d-none d-md-block">
                        <h5>${image.name}</h5>
                    </div>
                    </div>
                    `;  // Adicionar o nome da imagem como legenda
            }

            carouselHtml += `
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Anterior</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Próximo</span>
                </button>
                </div>
                `;

            // Inserir o carrossel no elemento com id "carrosel-images"
            const carouselContainer = document.getElementById('carrosel-images');
            carouselContainer.innerHTML = carouselHtml;
        }



        function renderFilter(columnsMetadata) {
            const dataList = document.getElementById('datalistOptions');
            dataList.innerHTML = '';


            columnsMetadata.forEach(column => {
                const option = document.createElement('option');
                option.value = column.column_name;
                dataList.appendChild(option);
            });

            const input = document.getElementById('exampleDataList');
            input.addEventListener('input', () => {
                const value = input.value.toLowerCase();
                const filteredColumns = columnsMetadata.filter(column => column.column_name.toLowerCase().includes(value));
                renderColumnsMetadata(filteredColumns);
            });

        }

        function renderColumnsMetadata(columnsMetadata) {
            const container = document.getElementById('columns-metadata-content');
            container.innerHTML = '';

            columnsMetadata.forEach(column => {
                const columnCard = document.createElement('div');
                columnCard.classList.add('card', 'mb-3');

                const columnCardBody = document.createElement('div');
                columnCardBody.classList.add('card-body');

                const columnTitle = document.createElement('h5');
                columnTitle.classList.add('card-title');
                columnTitle.textContent = column.column_name;

                const columnType = document.createElement('p');
                columnType.classList.add('card-text');
                columnType.textContent = `Tipo de dado: ${column.data_type}`;

                const columnDescription = document.createElement('p');
                columnDescription.classList.add('card-text');
                columnDescription.textContent = column.description;

                columnCardBody.appendChild(columnTitle);
                columnCardBody.appendChild(columnType);
                columnCardBody.appendChild(columnDescription);
                columnCard.appendChild(columnCardBody);
                container.appendChild(columnCard);
            });
        }

        async function carregarAnalisesOld() {
            const analises = await getAnalyses();

            const container = document.getElementById('analises-disponiveis');
            container.innerHTML = '';

            analises.results.forEach(analise => {
                const card = document.createElement('div');
                card.classList.add('card', 'mb-3');

                const cardBody = document.createElement('div');
                cardBody.classList.add('card-body');

                const title = document.createElement('h5');
                title.classList.add('card-title');
                title.textContent = `Análise ID: ${analise.id}`;

                const datasetId = document.createElement('p');
                datasetId.classList.add('card-text');
                datasetId.textContent = `Dataset ID: ${analise.dataset_id_id}`;

                const analysisType = document.createElement('p');
                analysisType.classList.add('card-text');
                analysisType.textContent = `Tipo de Análise: ${analise.analysis_type}`;

                const parameters = document.createElement('p');
                parameters.classList.add('card-text');
                parameters.textContent = `Parâmetros: ${analise.parameters}`;

                const createdAt = document.createElement('p');
                createdAt.classList.add('card-text');
                createdAt.textContent = `Criado em: ${formatarData(analise.created_at)}`;

                const status = document.createElement('p');
                status.classList.add('card-text');
                status.textContent = `Status: ${analise.status}`;

                if (analise.error_message) {
                    const errorMessage = document.createElement('p');
                    errorMessage.classList.add('card-text', 'text-danger');
                    errorMessage.textContent = `Erro: ${analise.error_message}`;
                    cardBody.appendChild(errorMessage);
                }

                cardBody.appendChild(title);
                cardBody.appendChild(datasetId);
                cardBody.appendChild(analysisType);
                cardBody.appendChild(parameters);
                cardBody.appendChild(createdAt);
                cardBody.appendChild(status);
                card.appendChild(cardBody);
                container.appendChild(card);
            });
        }

        // Chamar a função para carregar e exibir as análises disponíveis
        //carregarAnalises();

        // se #analises-disponiveis  estoiver carregado, chama a função
        if (document.getElementById('analises-disponiveis')) {
            carregarAnalises();
        }

        function showAnalysisDetails(analysis) {
            console.log(analysis);
            const modalBody = document.getElementById('analysisDetailsBody');
            modalBody.innerHTML = `
                        <p><strong>ID da Análise:</strong> ${analysis.id}</p>
                        <p><strong>ID do Dataset:</strong> ${analysis.dataset_id_id}</p>
                        <p><strong>Tipo de Análise:</strong> ${analysis.analysis_type}</p>
                        <p><strong>Status:</strong> ${analysis.status}</p>
                        <p><strong>Data de Criação:</strong> ${formatarData(analysis.created_at)}</p>
                        ${analysis.error_message ? `<p class="text-danger"><strong>Erro:</strong> ${analysis.error_message}</p>` : ''}
                    `;
            const modal = new bootstrap.Modal(document.getElementById('analysisDetailsModal'));
            modal.show();
        }

        function renderAnalysesAccordion(analyses) {

            const container = document.getElementById('accordion-analysis');

            console.log(analyses);

            // verifica se analyses é maior que 0
            if (analyses.length > 0) {
                container.innerHTML = '';
                analyses.forEach((analysis, index) => {
                    const accordionItem = document.createElement('div');
                    accordionItem.classList.add('accordion-item');

                    const accordionHeader = document.createElement('h2');
                    accordionHeader.classList.add('accordion-header');

                    const accordionButton = document.createElement('button');
                    accordionButton.classList.add('accordion-button', 'collapsed');
                    accordionButton.type = 'button';
                    accordionButton.setAttribute('data-bs-toggle', 'collapse');
                    accordionButton.setAttribute('data-bs-target', `#collapse${index}`);
                    accordionButton.setAttribute('aria-expanded', 'false');
                    accordionButton.setAttribute('aria-controls', `collapse${index}`);
                    accordionButton.textContent = `Análise ID: ${analysis.id} para a coluna ${analysis.parameters.target_column}`;

                    const accordionCollapse = document.createElement('div');
                    accordionCollapse.id = `collapse${index}`;
                    accordionCollapse.classList.add('accordion-collapse', 'collapse');
                    accordionCollapse.setAttribute('data-bs-parent', '#accordion-analysis');

                    const accordionBody = document.createElement('div');
                    accordionBody.classList.add('accordion-body');
                    accordionBody.innerHTML = `
                        <p><strong>ID do Dataset:</strong> ${analysis.dataset_id_id}</p>
                        <p><strong>Tipo de Análise:</strong> ${analysis.analysis_type}</p>
                        
                        <p><strong>Status:</strong> ${analysis.status}</p>
                        <p><strong>Data de Criação:</strong> ${formatarData(analysis.created_at)}</p>
                        ${analysis.error_message ? `<p class="text-danger"><strong>Erro:</strong> ${analysis.error_message}</p>` : ''}
                    `;

                    accordionHeader.appendChild(accordionButton);
                    accordionCollapse.appendChild(accordionBody);
                    accordionItem.appendChild(accordionHeader);
                    accordionItem.appendChild(accordionCollapse);
                    container.appendChild(accordionItem);
                });
            }

        }

        document.querySelectorAll('.btn-primary').forEach(button => {
            button.addEventListener('click', (event) => {
                const analysisId = event.target.closest('.card').querySelector('.card-header').textContent.split(': ')[1];
                const analysis = analisets.find(a => a.id == analysisId);

            });
        });

        carregarDatasets();
        carregarOpcoesDataset();

    </script>

    <script>

        document.addEventListener('DOMContentLoaded', async () => {
            const datasets = await getDatasets();
            if (datasets.length > 0) {
                const datasetId = datasets[0].id;
                const response = await fetch(`http://localhost:8000/api/datasets/${datasetId}/download`);
                if (response.ok) {
                    const csvData = await response.text();
                    const parsedData = parseCSV(csvData);

                    const dataGraphAll = [
                        'agua_vs_calorias',
                        'agua_por_tipo_atividade',
                        'calorias_por_tipo_atividade',
                        'duracao_vs_calorias',
                        'bpm_vs_experiencia',
                        'distribuicao_idade'
                    ];

                    dataGraphAll.forEach(graphType => {
                        generateChart(parsedData, graphType);
                    });
                } else {
                    alerta("Erro ao baixar o CSV.", 'alert-danger', "alert-message-insights");
                }
            } else {
                alerta("Nenhum dataset encontrado.", 'alert-warning', "alert-message-insights");
            }
        });

        // Add event listener to dropdown items
        document.querySelector('#insights-types').addEventListener('click', async (event) => {

            event.preventDefault();
            const selectElement = document.querySelector('#selec-dataset-insights');

            let datasetId = selectElement.value;

            if (!datasetId) {
                const datasets = await getDatasets();
                if (datasets.length > 0) {
                    datasetId = datasets[0].id;
                    selectElement.value = datasetId;
                } else {
                    alerta("Nenhum dataset encontrado.", 'alert-warning', "alert-message-insights");
                    return;
                }
            }

            console.log(datasetId);

            try {
                const response = await fetch(`http://localhost:8000/api/datasets/${datasetId}/download`);
                if (!response.ok) {
                    throw new Error('Erro ao baixar o CSV.');
                }
                const csvData = await response.text();
                const parsedData = parseCSV(csvData);

                const dataGraphAll = [
                    'agua_vs_calorias',
                    'agua_por_tipo_atividade',
                    'calorias_por_tipo_atividade',
                    'duracao_vs_calorias',
                    'bpm_vs_experiencia',
                    'distribuicao_idade'
                ];

                dataGraphAll.forEach(graphType => {
                    generateChart(parsedData, graphType);
                });
            } catch (error) {
                alerta(error.message, 'alert-danger', "alert-message-insights");
            }
        });

    </script>
    <script>
        // Estrutura de Análises
        const analises = {
            "agua_vs_calorias": {
                "titulo": "Relação entre Consumo de Água e Calorias Queimadas",
                "descricao": "Análise que examina como o consumo de água (water_intake_(liters)) está relacionado com a quantidade de calorias queimadas (calories_burned) durante os treinos. Isso ajuda a entender se uma maior hidratação está associada a um maior gasto calórico.",
                "grafico": "agua_vs_calorias"
            },
            "agua_por_tipo_atividade": {
                "titulo": "Consumo Médio de Água por Tipo de Atividade",
                "descricao": "Avalia o consumo médio de água para cada tipo de atividade.",
                "grafico": "agua_por_tipo_atividade"
            },
            "calorias_por_tipo_atividade": {
                "titulo": "Calorias Queimadas por Tipo de Atividade",
                "descricao": "Compara a média de calorias queimadas entre diferentes tipos de atividade.",
                "grafico": "calorias_por_tipo_atividade"
            },
            "duracao_vs_calorias": {
                "titulo": "Relação da Duração vs Calorias Queimadas",
                "descricao": "Investiga a relação entre a duração das sessões de treino e as calorias queimadas.",
                "grafico": "duracao_vs_calorias"
            },
            "bpm_vs_experiencia": {
                "titulo": "Variação de BPM por Nível de Experiência",
                "descricao": "Analisa como a frequência cardíaca média varia de acordo com o nível de experiência dos usuários.",
                "grafico": "bpm_vs_experiencia"
            },
            "clusterizacao_perfil": {
                "titulo": "Clusterização do Perfil dos Usuários",
                "descricao": "Utiliza técnicas de clusterização para agrupar usuários com perfis similares com base em múltiplos atributos.",
                "grafico": "clusterizacao_perfil"
            },
            "distribuicao_idade": {
                "titulo": "Distribuição de Idade dos Usuários",
                "descricao": "Exibe a distribuição de idade dos usuários da plataforma.",
                "grafico": "distribuicao_idade"
            }

            // Adicione outras análises conforme necessário
        };

        // Função para formatar títulos (ex.: "water_intake_liters" para "Consumo de Água (litros)")
        function formatTitle(field) {
            const mapping = {
                "water_intake_liters": "Consumo de Água (litros)",
                "calories_burned": "Calorias Queimadas",
                "workout_type": "Tipo de Atividade",
                "session_duration_hours": "Duração do Treino (horas)",
                "avg_bpm": "BPM Médio",
                "experience_level": "Nível de Experiência",
                "workout_frequency_days_week": "Frequência de Treinos (dias/semana)",
                "bmi": "IMC"
                // Adicione mais casos conforme necessário
            };
            return mapping[field] || field.replace(/_/g, " ").toUpperCase();
        }

        // Função para gerar cores aleatórias para diferentes grupos
        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        // Objeto para armazenar instâncias de gráficos
        const chartInstances = {};

        // Função para gerar gráficos com Chart.js
        function generateChart(dados, dataGraph) {

            const analise = Object.values(analises).find(a => a.grafico === dataGraph);

            if (!analise) {
                console.error(`Análise com grafico ID '${dataGraph}' não encontrada.`);
                return;
            }

            const chartsContainer = document.getElementById('chartsContainer');


            // Criar título e descrição
            const titulo = document.createElement('h2');
            titulo.textContent = analise.titulo;
            const descricao = document.createElement('p');
            descricao.textContent = analise.descricao;
            chartsContainer.appendChild(titulo);
            chartsContainer.appendChild(descricao);

            // Criar canvas único
            const canvas = document.createElement('canvas');
            const canvasId = `chartCanvas_${dataGraph}_${Date.now()}`;
            canvas.id = canvasId;
            canvas.className = 'chart';
            canvas.style.width = "400px";
            canvas.style.height = "200px";
            chartsContainer.appendChild(canvas);

            const ctx = canvas.getContext('2d');

            if (!ctx) {
                console.error(`Não foi possível obter o contexto para o canvas com ID ${canvasId}`);
                return;
            }

            // Configurar e criar o gráfico
            if (dataGraph === "agua_vs_calorias") {
                const chart = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'Água vs Calorias',
                            data: dados.map(row => ({
                                x: row["water_intake_(liters)"],
                                y: row["calories_burned"]
                            })),
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }]
                    },
                    options: {
                        plugins: {
                            title: {
                                display: true,
                                text: analise.tituloGrafico
                            }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'Água Consumida (litros)' }
                            },
                            y: {
                                title: { display: true, text: 'Calorias Queimadas' }
                            }
                        }
                    }
                });

                chartInstances[canvasId] = chart;
            }
            else if (dataGraph === "agua_por_tipo_atividade") {
                const activityTypes = [...new Set(dados.map(row => row["workout_type"]))];
                const waterConsumption = activityTypes.map(type => {
                    const totalWater = dados.filter(row => row["workout_type"] === type)
                        .reduce((sum, row) => sum + parseFloat(row["water_intake_(liters)"] || 0), 0);
                    return totalWater;
                });

                const chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: activityTypes,
                        datasets: [{
                            label: 'Consumo de Água (litros)',
                            data: waterConsumption,
                            backgroundColor: 'rgba(153, 102, 255, 0.5)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        plugins: {
                            title: {
                                display: true,
                                text: analise.tituloGrafico
                            }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'Tipo de Atividade' }
                            },
                            y: {
                                title: { display: true, text: 'Água Consumida (litros)' },
                                beginAtZero: true
                            }
                        }
                    }
                });

                chartInstances[canvasId] = chart;
            }
            else if (dataGraph === "calorias_por_tipo_atividade") {
                const activityTypes = [...new Set(dados.map(row => row["workout_type"]))];
                const caloriesBurned = activityTypes.map(type => {
                    return dados.filter(row => row["workout_type"] === type)
                        .reduce((sum, row) => sum + parseFloat(row["calories_burned"] || 0), 0);
                });

                const chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: activityTypes,
                        datasets: [{
                            label: 'Calorias Queimadas',
                            data: caloriesBurned,
                            backgroundColor: 'rgba(255, 159, 64, 0.5)',
                            borderColor: 'rgba(255, 159, 64, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        plugins: {
                            title: {
                                display: true,
                                text: analise.tituloGrafico
                            }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'Tipo de Atividade' }
                            },
                            y: {
                                title: { display: true, text: 'Calorias Queimadas' },
                                beginAtZero: true
                            }
                        }
                    }
                });

                chartInstances[canvasId] = chart;
            }
            else if (dataGraph === "duracao_vs_calorias") {
                const chart = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'Duração vs Calorias',
                            data: dados.map(row => ({
                                x: row["session_duration_(hours)"],
                                y: row["calories_burned"]
                            })),
                            backgroundColor: 'rgba(255, 206, 86, 0.5)',
                            borderColor: 'rgba(255, 206, 86, 1)',
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }]
                    },
                    options: {
                        plugins: {
                            title: {
                                display: true,
                                text: analise.tituloGrafico
                            }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'Duração da Sessão (horas)' }
                            },
                            y: {
                                title: { display: true, text: 'Calorias Queimadas' }
                            }
                        }
                    }
                });

                chartInstances[canvasId] = chart;
            }
            else if (dataGraph === "bpm_vs_experiencia") {
                const experienceLevels = [...new Set(dados.map(row => row["experience_level"]))];
                const avgBpm = experienceLevels.map(level => {
                    const bpmValues = dados.filter(row => row["experience_level"] === level)
                        .map(row => parseFloat(row["avg_bpm"] || 0));
                    const average = bpmValues.reduce((sum, val) => sum + val, 0) / bpmValues.length;
                    return average;
                });

                const chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: experienceLevels,
                        datasets: [{
                            label: 'BPM Médio',
                            data: avgBpm,
                            backgroundColor: 'rgba(75, 192, 192, 0.5)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        plugins: {
                            title: {
                                display: true,
                                text: analise.tituloGrafico
                            }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'Nível de Experiência' }
                            },
                            y: {
                                title: { display: true, text: 'BPM Médio' },
                                beginAtZero: true
                            }
                        }
                    }
                });

                chartInstances[canvasId] = chart;
            }
            else if (dataGraph === "distribuicao_idade") {
                // Extrair todas as idades dos dados
                const ages = dados.map(row => parseInt(row["age"], 10));

                // Definir faixas etárias
                const ageBins = [20, 30, 40, 50, 60, 70, 80];
                const ageLabels = ['<20', '20-29', '30-39', '40-49', '50-59', '60-69', '70+'];
                const ageCounts = new Array(ageLabels.length).fill(0);

                // Contar quantos usuários estão em cada faixa etária
                ages.forEach(age => {
                    if (age < 20) {
                        ageCounts[0]++;
                    } else if (age >= 70) {
                        ageCounts[ageCounts.length - 1]++;
                    } else {
                        for (let i = 1; i < ageBins.length - 1; i++) {
                            if (age >= ageBins[i - 1] && age < ageBins[i]) {
                                ageCounts[i]++;
                                break;
                            }
                        }
                    }
                });

                // Criar o gráfico
                const chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ageLabels,
                        datasets: [{
                            label: 'Número de Usuários',
                            data: ageCounts,
                            backgroundColor: 'rgba(153, 102, 255, 0.5)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        plugins: {
                            title: {
                                display: true,
                                text: 'Distribuição de Idade dos Usuários'
                            }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'Faixa Etária' }
                            },
                            y: {
                                title: { display: true, text: 'Número de Usuários' },
                                beginAtZero: true
                            }
                        }
                    }
                });

                chartInstances[canvasId] = chart;
            }

            else if (dataGraph === "clusterizacao_perfil") {
                // Chart.js não suporta scatter 3D diretamente
                // Recomendo usar Plotly.js para este tipo de gráfico

                // Verifique se a coluna 'cluster' existe nos dados
                const hasCluster = dados.some(row => row['cluster'] !== undefined);
                if (!hasCluster) {
                    alerta("Coluna 'cluster' não encontrada nos dados para clusterização.", 'alert-danger', "alert-message-insights");
                    return;
                }

                // Incluir Plotly.js via CDN se ainda não estiver incluído
                if (!window.Plotly) {
                    const script = document.createElement('script');
                    script.src = "https://cdn.plot.ly/plotly-latest.min.js";
                    document.head.appendChild(script);
                    script.onload = () => {
                        gerarGraficoPlotly3D(dados, analise, canvasId);
                    };
                } else {
                    gerarGraficoPlotly3D(dados, analise, canvasId);
                }
            }
        }

        // Função para gerar gráfico 3D com Plotly.js
        function gerarGraficoPlotly3D(dados, analise, canvasId) {
            // Separar dados por cluster
            const clusters = [...new Set(dados.map(row => row['cluster']))];
            const dataPlots = clusters.map(cluster => ({
                x: dados.filter(row => row['cluster'] === cluster).map(row => row[analise.x]),
                y: dados.filter(row => row['cluster'] === cluster).map(row => row[analise.y]),
                z: dados.filter(row => row['cluster'] === cluster).map(row => row[analise.z]),
                mode: 'markers',
                type: 'scatter3d',
                name: `Cluster ${cluster}`,
                marker: {
                    size: 5,
                    color: getRandomColor(),
                    opacity: 0.8
                }
            }));

            const layout = {
                title: analise.tituloGrafico,
                scene: {
                    xaxis: { title: formatTitle(analise.x) },
                    yaxis: { title: formatTitle(analise.y) },
                    zaxis: { title: formatTitle(analise.z) }
                }
            };

            Plotly.newPlot(canvasId, dataPlots, layout);
        }

        // Função para renderInsights, simulação
        async function renderInsights() {
            // Simula a chamada para obter insights_types
            // Substitua com sua lógica de obtenção dos insights
            return {
                "insights_types": [
                    {
                        "titulo": "Relação entre Consumo de Água e Calorias Queimadas",
                        "descricao": "Análise que examina como o consumo de água (water_intake_(liters)) está relacionado com a quantidade de calorias queimadas (calories_burned) durante os treinos. Isso ajuda a entender se uma maior hidratação está associada a um maior gasto calórico.",
                        "grafico": "agua_vs_calorias"
                    },
                    {
                        "titulo": "Consumo Médio de Água por Tipo de Atividade",
                        "descricao": "Avalia o consumo médio de água para cada tipo de atividade.",
                        "grafico": "agua_por_tipo_atividade"
                    },
                    {
                        "titulo": "Calorias Queimadas por Tipo de Atividade",
                        "descricao": "Compara a média de calorias queimadas entre diferentes tipos de atividade.",
                        "grafico": "calorias_por_tipo_atividade"
                    },
                    {
                        "titulo": "Relação da Duração vs Calorias Queimadas",
                        "descricao": "Investiga a relação entre a duração das sessões de treino e as calorias queimadas.",
                        "grafico": "duracao_vs_calorias"
                    },
                    {
                        "titulo": "Variação de BPM por Nível de Experiência",
                        "descricao": "Analisa como a frequência cardíaca média varia de acordo com o nível de experiência dos usuários.",
                        "grafico": "bpm_vs_experiencia"
                    },
                    {
                        "titulo": "Clusterização do Perfil dos Usuários",
                        "descricao": "Utiliza técnicas de clusterização para agrupar usuários com perfis similares com base em múltiplos atributos.",
                        "grafico": "clusterizacao_perfil"
                    }
                ]
            };
        }

        // Função para parseCSV
        function parseCSV(csvData) {
            return Papa.parse(csvData, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true
            }).data;
        }


    </script>



</body>

</html>