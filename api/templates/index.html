<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Exibição de Dados</title>
    <!-- Bootstrap CSS via CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav" style="height: 5vh;"></div>
        </div>
    </nav>

    <div class="container mt-5" style="min-height: calc(90vh - 10vh - 5vh);">

        <div class="d-flex align-items-start">
            <div class="nav flex-column nav-pills col-10 offset-1 col-lg-3 " id="v-pills-tab" role="tablist"
                aria-orientation="vertical">

                <button class="nav-link" id="v-pills-home-tab" data-bs-toggle="pill" data-bs-target="#v-pills-home"
                    type="button" role="tab" aria-controls="v-pills-home" aria-selected="true">Datasets</button>
                <button class="nav-link" id="v-pills-profile-tab" data-bs-toggle="pill"
                    data-bs-target="#v-pills-profile" type="button" role="tab" aria-controls="v-pills-profile"
                    aria-selected="false">Analysis</button>

                <!-- Adiciona a opção Insights -->

                <button class="nav-link active" id="v-pills-insights-tab" data-bs-toggle="pill"
                    data-bs-target="#v-pills-insights" type="button" role="tab" aria-controls="v-pills-insights"
                    aria-selected="false">Insights</button>

                <button class="nav-link" id="v-pills-messages-tab" data-bs-toggle="pill"
                    data-bs-target="#v-pills-messages" type="button" role="tab" aria-controls="v-pills-messages"
                    aria-selected="false">Explore</button>

                <div id="search-list" class="mt-5 mb-3">
                    <input class="form-control" list="datalistOptions" id="exampleDataList"
                        placeholder="Pesquisar definições">
                    <datalist id="datalistOptions"></datalist>
                </div>

                <div id="alert-message-search"></div>

                <div class="mt-3" style="max-height: 500px; overflow-y: auto;">
                    <div id="columns-metadata-content" class="mt-3"></div>
                </div>
            </div>

            <div class="tab-content col-10 offset-1 col-lg-7" id="v-pills-tabContent">

                <!-- INFORMAÇÃO DO DATASETS CADASTRADOS -->
                <div class="tab-pane fade" id="v-pills-home" role="tabpanel" aria-labelledby="v-pills-home-tab"
                    tabindex="0">

                    <div class="col-10 offset-1">
                        <div class="mb-3 ">
                            <label for="formFile" class="form-label">
                                <h4>Envie seu arquivo</h4>
                                <p>
                                    <small>Envie um arquivo CSV para ser processado.</small>
                                </p>
                            </label>
                            <input class="form-control" type="file" id="formFile">
                            
                        </div>
                        <div id="alert-message-datasets"></div>
                        <div id="dataset-content" class="mt-3"></div>
                        <div id="resultados-content" class="mt-3"></div>

                    </div>

                </div>

                <!-- ANALYSES -->
                <div class="tab-pane fade" id="v-pills-profile" role="tabpanel" aria-labelledby="v-pills-profile-tab"
                    tabindex="0">
                    <div class="col-10 offset-1">

                        <h4>Selecione o dataset</h4>
                        <p>
                            <small>Selecione o dataset que deseja analisar.</small>
                        </p>
                        <div id="alert-message" class="m-3"></div>
                        <div class="form">
                            <select class="form-select" aria-label="Relação de dataset cadastrado">
                                <option selected>Selecione o seu database</option>
                            </select>
                        </div>

                        <div id="filter-select" class="mt-3"></div>

                        <div id="target_column" class="mt-3"></div>

                        <div id="alert-message-analyses"></div>

                        <div id="datalist-options" class="m-3"></div>

                        <div id="carrosel-images" class="mt-3"></div>

                        <div class="accordion mt-4" id="accordion-analysis"></div>

                        <div id="friendly-message-container"></div>

                    </div>

                </div>

                <!-- INSIGHTS -->
                <div class="tab-pane fade show active" id="v-pills-insights" role="tabpanel"
                    aria-labelledby="v-pills-insights-tab" tabindex="0">

                    <div class="col-10 offset-1">
                        <h4>Insights</h4>
                        <p>
                            <small>Confira os insights gerados a partir das análises.</small>
                        </p>
                        <div class="row">
                            <div class="col mb-4">
                                <div class="input-group">
                                    <input type="file" class="form-control" id="inputGroupFile04"
                                        aria-describedby="inputGroupFileAddon04" aria-label="Upload">
                                    <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                                        data-bs-toggle="dropdown" aria-expanded="false">Selecionar</button>
                                    <ul class="dropdown-menu dropdown-menu-end"></ul>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-body">
                                <canvas id="generateCharts" width="400" height="200"></canvas>
                            </div>
                            <div id="alert-message-insights"></div>
                        </div>

                    </div>

                </div>

                <!-- EXPLORE -->
                <div class="tab-pane fade" id="v-pills-messages" role="tabpanel" aria-labelledby="v-pills-messages-tab"
                    tabindex="0">

                    <div class="col-10 offset-1">
                        <h4>Explorar</h4>
                        <p>
                            <small>Confira a análise que deseja visualizar.</small>
                        </p>
                        <div id="alert-message-explore"></div>

                    </div>
                </div>

            </div>
        </div>
    </div>

    <footer class="bg-light text-center text-lg-start mt-5">
        <div class="container p-4">
            <div class="row">
                <div class="col-lg-6 col-md-12 mb-4 mb-md-0">
                    <h5 class="text-uppercase">Sobre</h5>
                    <p>
                        Este é um projeto para exibição e análise de dados. Envie seus arquivos CSV e visualize os
                        resultados das análises.
                    </p>
                </div>

                <div class="col-lg-3 col-md-6 mb-4 mb-md-0">

                </div>
            </div>
        </div>
        <div class="text-center p-3 bg-dark text-white">
            2024 Tópicos Especiais em Software <br>
            UP - Universidade Positivo <br>
            Curutiba - PR

        </div>
    </footer>

    <!-- Bootstrap JS via CDN (incluindo Popper.js) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // funcao para retornar todos os dataset cadastrados curl --location 'http://localhost:8000/api/datasets'
        async function getDatasets() {
            const response = await fetch('http://localhost:8000/api/datasets');
            const data = await response.json();
            return data;
        }

        // funcnao para remover um dataset pelo id curl --location --request DELETE 'http://localhost:8000/api/datasets/5/remove'
        async function removeDataset(id) {
            const response = await fetch(`http://localhost:8000/api/datasets/${id}/remove`, {
                method: 'DELETE'
            });
            let data;
            try {
                data = await response.json();
            } catch (error) {
                data = { error: 'Failed to parse JSON response' };
            }
            return data;
        }

        // função para upload de arquivo
        async function uploadFile() {
            const formData = new FormData();
            formData.append('file', document.querySelector('input[type="file"]').files[0]);
            const response = await fetch('http://localhost:8000/api/datasets/upload', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            
            if (data.error) {
                alerta(data.error, 'alert-danger', "alert-message-datasets");
            } else {
                alerta('Seu arquivo foi cadastrado!', 'alert-success', "alert-message-datasets");
            }

            // salva no localsotrage o caminho do arquivo
            localStorage.setItem('file', data.file);

            return data;
        }

        // função curl --location 'http://localhost:8000/api/datasets/9'
        async function getDataset(id) {
            const response = await fetch(`http://localhost:8000/api/datasets/${id}`);
            const data = await response.json();
            if (data.error) {
                alerta("Não foi possível encontrar seu dataset.", 'alert-danger', "alert-message-datasets");
            }else{
                renderColumnsMetadata(data.columns_metadata);
            }
            return data;
        }

        // fetch para obter análise, passando um target_column 
        // curl --location 'http://localhost:8000/api/analyses/24?target_column=workout_frequency_(days%2Fweek)'
        async function getAnalysis(id, targetColumn) {
            const response = await fetch(`http://localhost:8000/api/analyses/${id}?target_column=${targetColumn}`);
            const data = await response.json();
            return data;
        }

        // obter curl --location 'http://localhost:8000/api/analyses'
        async function getAnalyses() {
            const response = await fetch('http://localhost:8000/api/analyses');
            const data = await response.json();
            renderAnalysesCollapse(data);
            return data;
        }

        async function carregarAnalises() {
            const analises = await getAnalyses();

            // se length for maior que 0, chama a função
            if (analises.length > 0) {
                renderAnalysesCollapse(analises);
            } else {
                alerta('Não existem análises, selecione um dataset.', 'alert-info', "alert-message-analyses");
            }
        }

        // http://localhost:8000/api/insights/types

        async function getInsights() {
            const response = await fetch('http://localhost:8000/api/insights/types');
            const data = await response.json();
            return data;
        }

        // curl --location 'http://localhost:8000/api/images/erro'
        async function getImages(arquivo) {
            const response = await fetch('http://localhost:8000/api/images/' + arquivo);
            const data = await response.json();

            if (data.error) {
                console.error(data.error);
            } 

            return data;
        }

        // curl de analises com até 4 filtros curl --location 'http://localhost:8000/api/analyses/filtered?analysis_type=PREDICTION&status=COMPLETED&target_column=experience_level&database_id=46'

        async function getAnalysesFiltered(database_id) {
            const response = await fetch(`http://localhost:8000/api/analyses/filtered?database_id=${database_id}`);
            const data = await response.json();

            // em caso de sucesso, renderAnalysesAccordion(analisets);
            if (data.length > 0) {
                renderAnalysesAccordion(data);
            } else {
                alerta('Nenhuma análise encontrada.', 'alert-info' , "alert-message-analyses");
            }

            return data;
        }


        function renderAnalysesCollapse(analises) {
            const container = document.getElementById('analises-disponiveis');
            container.innerHTML = '';

            /*
                "id": 4,
                "dataset_id_id": 40,
                "analysis_type": "PREDICTION",
                "parameters": {
                    "target_column": "age"
                },
                "created_at": "2024-11-26T23:37:36.538Z",
                "status": "COMPLETED",
                "error_message": ""
            */

            analises.forEach(analise => {
                const card = document.createElement('div');
                card.classList.add('card', 'text-center', 'mb-3');

                const cardHeader = document.createElement('div');
                cardHeader.classList.add('card-header');
                cardHeader.textContent = `Análise ID: ${analise.id}`;

                const cardBody = document.createElement('div');
                cardBody.classList.add('card-body');

                const cardTitle = document.createElement('h5');
                cardTitle.classList.add('card-title');
                cardTitle.textContent = `Dataset ID: ${analise.dataset_id_id}`;

                const cardText = document.createElement('p');
                cardText.classList.add('card-text');
                cardText.textContent = `Tipo de Análise: ${analise.analysis_type}`;

                const cardLink = document.createElement('a');
                cardLink.href = '#';
                cardLink.classList.add('btn', 'btn-primary');
                cardLink.textContent = 'Ver detalhes';

                cardBody.appendChild(cardTitle);
                cardBody.appendChild(cardText);
                cardBody.appendChild(cardLink);

                const cardFooter = document.createElement('div');
                cardFooter.classList.add('card-footer', 'text-body-secondary');
                cardFooter.textContent = `Criado em: ${formatarData(analise.created_at)}`;

                card.appendChild(cardHeader);
                card.appendChild(cardBody);
                card.appendChild(cardFooter);

                container.appendChild(card);
            });
        }

        // Função para formatar a data para 'dd/mm hh:mm'
        function formatarData(dataISO) {
            const data = new Date(dataISO);
            const dia = String(data.getDate()).padStart(2, '0');
            const mes = String(data.getMonth() + 1).padStart(2, '0'); // Mês inicia em zero
            const ano = data.getFullYear();
            const hora = String(data.getHours()).padStart(2, '0');
            const minuto = String(data.getMinutes()).padStart(2, '0');
            return `${dia}/${mes}/${ano} às ${hora}:${minuto}`;
        }

        // Função para exibir o dataset de forma amigável
        function exibirDataset(dataset) {
            const container = document.getElementById('dataset-content'); // Certifique-se de que este elemento existe no seu HTML
            const html = `
                    <div class="card mb-3">
                        <div class="card-header">
                            <strong>${dataset.filename.length > 10 ? dataset.filename.substring(0, 20) + '..' : dataset.filename}.csv</strong>
                        <button class="btn btn-danger btn-sm float-end" onclick="removeDataset(${dataset.id}).then(carregarDatasets)">Excluir</button>
                        </div>
                        <div class="card-body">
                            <p>                    
                                <span class="badge text-bg-primary rounded-pill ${dataset.status === 'PROCESSED' ? 'bg-success' : 'bg-secondary'}">${dataset.status}</span>
                                <span class="ms-3">${dataset.status === 'PROCESSED' ? '✅' : '⏳'}</span>
                                <strong  >ID:</strong> ${dataset.id}
                                
                            </p>
                            <p><strong>Data de Envio:</strong> ${formatarData(dataset.uploaded_at)}</p>
                            
                            <div class="accordion" id="accordionExample">
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${dataset.id}" aria-expanded="true" aria-controls="collapse${dataset.id}">
                                            <span class="badge text-bg-primary me-3 rounded-pill">${dataset.columns.length}</span> Colunas 
                                        </button>
                                        
                                    </h2>
                                    <div id="collapse${dataset.id}" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                                        <div class="accordion-body">
                                            
                                            <ul>
                                                ${dataset.columns.map(coluna => `<li>${coluna}</li>`).join('')}
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                
    `;
            container.innerHTML += html;
        }

        async function carregarDatasets() {
            const datasets = await getDatasets();

            // Limpar o conteúdo anterior
            document.getElementById('dataset-content').innerHTML = '';

            // Exibir cada dataset
            if (datasets.length > 0) {
                datasets.forEach(dataset => {
                    exibirDataset(dataset);
                });
            } else {
                document.getElementById('dataset-content').innerHTML = '<p class="text-muted">Nenhum dataset encontrado</p>';
            }
        }

        // Chamar a função para carregar e exibir os datasets


        document.getElementById('formFile').addEventListener('change', async (event) => {
            const result = await uploadFile();
            console.log(result);

            carregarDatasets();

        });

        async function updateDatasetOptions(datasets) {
            const selectElement = document.querySelector('select[aria-label="Relação de dataset cadastrado"]');
            const targetColumnElement = document.getElementById('target_column');

            // Limpar as opções anteriores
            selectElement.innerHTML = '<option selected>Selecione o seu dataset</option>';
            targetColumnElement.innerHTML = '';

            // Adicionar novas opções
            if (datasets != undefined) {
                datasets.forEach(dataset => {
                    const optionElement = document.createElement('option');
                    optionElement.value = dataset.id;
                    optionElement.textContent = `ID: ${dataset.id} - ${dataset.status}`;
                    selectElement.appendChild(optionElement);
                });
            } else {
                const container = document.getElementById('friendly-message-container');

                const images = await getImages('erro');
                
                console.log(images);
                
                const optionElement = document.createElement('option');
                optionElement.textContent = 'Nenhum dataset encontrado.';                
                selectElement.appendChild(optionElement);
                
                const messageHtml = `
                    <div class="card mb-3">
                        <img src="${images ? `data:image/png;base64,${images}` : ''}" class="card-img-top" alt="Friendly Image">
                        <div class="card-body">
                            <h5 class="card-title">Quase lá!</h5>
                            <p class="card-text">Você precisa cadastrar um dataset ou selecionar um existente.</p>
                        </div>
                    </div>
                `;
                container.innerHTML = messageHtml;
            }


        }

        // Chamar a função para carregar e exibir os datasets
        carregarDatasets().then(datasets => {
            updateDatasetOptions(datasets);
        });

        async function carregarOpcoesDataset() {

            const datasets = await getDatasets();

            /* carrega o primeiro dataset
            if (datasets.length > 0) {
                const data = await getDataset(datasets[0].id);
                renderFilter(data.columns_metadata);
                createCarousel(data.images);
                exibirFiltro(data.columns_metadata, document.getElementById('filter-select'), datasets[0].id);
                const dados = await getAnalysesFiltered(datasets[0].id);
                console.log(dados);
            }*/

            const selectElement = document.querySelector('select[aria-label="Relação de dataset cadastrado"]');
            if (selectElement) {
                selectElement.addEventListener('change', async (event) => {
                    const datasetId = event.target.value;
                    const data = await getDataset(datasetId);
                    renderFilter(data.columns_metadata);
                    createCarousel(data.images);
                    exibirFiltro(data.columns_metadata, document.getElementById('filter-select'), datasetId);
                    const dados = await getAnalysesFiltered(datasetId);
                });
            }

        }

        function alerta(message, type = 'alert-warning', id_div ) {
            const alertContainer = document.getElementById(id_div);
            const alert = document.createElement('div');
            alert.classList.add('alert', type, 'alert-dismissible', 'fade', 'show');
            alert.setAttribute('role', 'alert');
            alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            alertContainer.appendChild(alert);

            // Remove the alert after 3 seconds
            setTimeout(() => {
            alert.classList.remove('show');
            alert.classList.add('hide');
            setTimeout(() => {
                alert.remove();
            }, 500); // Wait for the fade-out transition to complete
            }, 3000);
        }

        // Chamar a função para carregar e exibir as opções de datasets


        function exibirFiltro(columnsMetadata, containerElement, datasetId) {
            // Criar o contêiner do grupo de input
            const inputGroup = document.createElement('div');
            inputGroup.classList.add('input-group');

            // Criar o select para os atributos (substituindo o input)
            const selectAttributes = document.createElement('select');
            selectAttributes.classList.add('form-select');
            selectAttributes.setAttribute('aria-label', 'Selecione um atributo');

            const defaultOption = document.createElement('option');
            defaultOption.selected = true;
            defaultOption.disabled = true;
            defaultOption.textContent = 'Escolher atributo';
            selectAttributes.appendChild(defaultOption);

            // Adicionar opções dos atributos
            columnsMetadata.forEach(column => {
                const optionElement = document.createElement('option');
                optionElement.value = column.column_name;
                optionElement.textContent = column.column_name;
                optionElement.dataset.type = column.data_type; // Armazenar o tipo de dado
                selectAttributes.appendChild(optionElement);
            });

            inputGroup.appendChild(selectAttributes);

            // Botão "Buscar"
            const buttonBuscar = document.createElement('button');
            buttonBuscar.type = 'button';
            buttonBuscar.classList.add('btn', 'btn-outline-secondary');
            buttonBuscar.textContent = 'Treinar a base';
            inputGroup.appendChild(buttonBuscar);

            // Event listener para o botão "Buscar"
            buttonBuscar.addEventListener('click', async () => {
                const selectedAttribute = selectAttributes.value;
                const analysis = await getAnalysis(datasetId, selectedAttribute);

                if (analysis.error) {
                    alerta("Selecione um atributo válido.", 'alert-danger', "alert-message-analyses");
                } else {
                    setTimeout(() => {
                        showAnalysisDetails(analysis);
                    }, 1000);

                }

            });

            // Botão de dropdown para filtrar tipos
            const buttonDropdown = document.createElement('button');
            buttonDropdown.type = 'button';
            buttonDropdown.classList.add('btn', 'btn-outline-secondary', 'dropdown-toggle', 'dropdown-toggle-split');
            buttonDropdown.setAttribute('data-bs-toggle', 'dropdown');
            buttonDropdown.setAttribute('aria-expanded', 'false');
            const spanElement = document.createElement('span');
            spanElement.classList.add('visually-hidden');
            spanElement.textContent = 'Filtrar por tipo de dado';
            buttonDropdown.appendChild(spanElement);
            inputGroup.appendChild(buttonDropdown);

            // Menu dropdown
            const ulElement = document.createElement('ul');
            ulElement.classList.add('dropdown-menu', 'dropdown-menu-end');

            // Obter os tipos de data_type únicos
            const dataTypes = [...new Set(columnsMetadata.map(column => column.data_type))];

            // Criar os itens do dropdown com os data_types
            dataTypes.forEach(type => {
                const liElement = document.createElement('li');
                const aElement = document.createElement('a');
                aElement.classList.add('dropdown-item');
                aElement.textContent = type;
                aElement.addEventListener('click', () => {
                    // Filtrar opções no selectAttributes
                    for (let i = 0; i < selectAttributes.options.length; i++) {
                        const option = selectAttributes.options[i];
                        if (option.dataset.type === type || option.value === '') {
                            option.hidden = false;
                        } else {
                            option.hidden = true;
                        }
                    }
                    // Resetar a seleção
                    selectAttributes.selectedIndex = 0;
                });
                liElement.appendChild(aElement);
                ulElement.appendChild(liElement);
            });

            inputGroup.appendChild(ulElement);

            // Limpar o container e adicionar o novo input group
            containerElement.innerHTML = '';
            containerElement.appendChild(inputGroup);
        }

        function createCarousel(images) {
            if (!images || images.length === 0) {
                // Se não houver imagens, não faz nada
                return;
            }

            // Início da estrutura do carrossel
            let carouselHtml = `
                <div id="carouselExampleIndicators" class="carousel slide">
                <div class="carousel-indicators">
                `;

            // Criar os indicadores
            for (let i = 0; i < images.length; i++) {
                carouselHtml += `
                    <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="${i}" ${i === 0 ? 'class="active"' : ''} ${i === 0 ? 'aria-current="true"' : ''} aria-label="Slide ${i + 1}"></button>
                    `;
            }

            carouselHtml += `
                </div>
                <div class="carousel-inner">
                `;

            // Criar os itens do carrossel
            for (let i = 0; i < images.length; i++) {
                const image = images[i];
                const mimeType = 'image/png'; // Ajuste se necessário
                carouselHtml += `
                    <div class="carousel-item ${i === 0 ? 'active' : ''}">
                    <img src="data:${mimeType};base64,${image.data}" class="d-block w-100" alt="${image.name}">
                    <div class="carousel-caption d-none d-md-block">
                        <h5>${image.name}</h5>
                    </div>
                    </div>
                    `;  // Adicionar o nome da imagem como legenda
            }

            carouselHtml += `
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Anterior</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Próximo</span>
                </button>
                </div>
                `;

            // Inserir o carrossel no elemento com id "carrosel-images"
            const carouselContainer = document.getElementById('carrosel-images');
            carouselContainer.innerHTML = carouselHtml;
        }



        function renderFilter(columnsMetadata) {
            const dataList = document.getElementById('datalistOptions');
            dataList.innerHTML = '';


            columnsMetadata.forEach(column => {
                const option = document.createElement('option');
                option.value = column.column_name;
                dataList.appendChild(option);
            });

            const input = document.getElementById('exampleDataList');
            input.addEventListener('input', () => {
                const value = input.value.toLowerCase();
                const filteredColumns = columnsMetadata.filter(column => column.column_name.toLowerCase().includes(value));
                renderColumnsMetadata(filteredColumns);
            });

        }

        function renderColumnsMetadata(columnsMetadata) {
            const container = document.getElementById('columns-metadata-content');
            container.innerHTML = '';

            columnsMetadata.forEach(column => {
                const columnCard = document.createElement('div');
                columnCard.classList.add('card', 'mb-3');

                const columnCardBody = document.createElement('div');
                columnCardBody.classList.add('card-body');

                const columnTitle = document.createElement('h5');
                columnTitle.classList.add('card-title');
                columnTitle.textContent = column.column_name;

                const columnType = document.createElement('p');
                columnType.classList.add('card-text');
                columnType.textContent = `Tipo de dado: ${column.data_type}`;

                const columnDescription = document.createElement('p');
                columnDescription.classList.add('card-text');
                columnDescription.textContent = column.description;

                columnCardBody.appendChild(columnTitle);
                columnCardBody.appendChild(columnType);
                columnCardBody.appendChild(columnDescription);
                columnCard.appendChild(columnCardBody);
                container.appendChild(columnCard);
            });
        }

        async function carregarAnalisesOld() {
            const analises = await getAnalyses();

            const container = document.getElementById('analises-disponiveis');
            container.innerHTML = '';

            analises.results.forEach(analise => {
                const card = document.createElement('div');
                card.classList.add('card', 'mb-3');

                const cardBody = document.createElement('div');
                cardBody.classList.add('card-body');

                const title = document.createElement('h5');
                title.classList.add('card-title');
                title.textContent = `Análise ID: ${analise.id}`;

                const datasetId = document.createElement('p');
                datasetId.classList.add('card-text');
                datasetId.textContent = `Dataset ID: ${analise.dataset_id_id}`;

                const analysisType = document.createElement('p');
                analysisType.classList.add('card-text');
                analysisType.textContent = `Tipo de Análise: ${analise.analysis_type}`;

                const parameters = document.createElement('p');
                parameters.classList.add('card-text');
                parameters.textContent = `Parâmetros: ${analise.parameters}`;

                const createdAt = document.createElement('p');
                createdAt.classList.add('card-text');
                createdAt.textContent = `Criado em: ${formatarData(analise.created_at)}`;

                const status = document.createElement('p');
                status.classList.add('card-text');
                status.textContent = `Status: ${analise.status}`;

                if (analise.error_message) {
                    const errorMessage = document.createElement('p');
                    errorMessage.classList.add('card-text', 'text-danger');
                    errorMessage.textContent = `Erro: ${analise.error_message}`;
                    cardBody.appendChild(errorMessage);
                }

                cardBody.appendChild(title);
                cardBody.appendChild(datasetId);
                cardBody.appendChild(analysisType);
                cardBody.appendChild(parameters);
                cardBody.appendChild(createdAt);
                cardBody.appendChild(status);
                card.appendChild(cardBody);
                container.appendChild(card);
            });
        }

        // Chamar a função para carregar e exibir as análises disponíveis
        //carregarAnalises();

        // se #analises-disponiveis  estoiver carregado, chama a função
        if (document.getElementById('analises-disponiveis')) {
            carregarAnalises();
        }

        function showAnalysisDetails(analysis) {
            const modalBody = document.getElementById('analysisDetailsBody');
            modalBody.innerHTML = `
                        <p><strong>ID da Análise:</strong> ${analysis.id}</p>
                        <p><strong>ID do Dataset:</strong> ${analysis.dataset_id_id}</p>
                        <p><strong>Tipo de Análise:</strong> ${analysis.analysis_type}</p>
                        <p><strong>Coluna Alvo:</strong> ${analysis.parameters.target_column}</p>
                        <p><strong>Status:</strong> ${analysis.status}</p>
                        <p><strong>Data de Criação:</strong> ${formatarData(analysis.created_at)}</p>
                        ${analysis.error_message ? `<p class="text-danger"><strong>Erro:</strong> ${analysis.error_message}</p>` : ''}
                    `;
            const modal = new bootstrap.Modal(document.getElementById('analysisDetailsModal'));
            modal.show();
        }

        function renderAnalysesAccordion(analyses) {

            const container = document.getElementById('accordion-analysis');

            // verifica se analyses é maior que 0
            if (analyses.length > 0) {
                container.innerHTML = '';
                analyses.forEach((analysis, index) => {
                    const accordionItem = document.createElement('div');
                    accordionItem.classList.add('accordion-item');

                    const accordionHeader = document.createElement('h2');
                    accordionHeader.classList.add('accordion-header');

                    const accordionButton = document.createElement('button');
                    accordionButton.classList.add('accordion-button', 'collapsed');
                    accordionButton.type = 'button';
                    accordionButton.setAttribute('data-bs-toggle', 'collapse');
                    accordionButton.setAttribute('data-bs-target', `#collapse${index}`);
                    accordionButton.setAttribute('aria-expanded', 'false');
                    accordionButton.setAttribute('aria-controls', `collapse${index}`);
                    accordionButton.textContent = `Análise ID: ${analysis.id} para a coluna ${analysis.parameters.target_column}`;

                    const accordionCollapse = document.createElement('div');
                    accordionCollapse.id = `collapse${index}`;
                    accordionCollapse.classList.add('accordion-collapse', 'collapse');
                    accordionCollapse.setAttribute('data-bs-parent', '#accordion-analysis');

                    const accordionBody = document.createElement('div');
                    accordionBody.classList.add('accordion-body');
                    accordionBody.innerHTML = `
                        <p><strong>ID do Dataset:</strong> ${analysis.dataset_id_id}</p>
                        <p><strong>Tipo de Análise:</strong> ${analysis.analysis_type}</p>
                        <p><strong>Coluna Alvo:</strong> ${analysis.parameters.target_column}</p>
                        <p><strong>Status:</strong> ${analysis.status}</p>
                        <p><strong>Data de Criação:</strong> ${formatarData(analysis.created_at)}</p>
                        ${analysis.error_message ? `<p class="text-danger"><strong>Erro:</strong> ${analysis.error_message}</p>` : ''}
                    `;

                    accordionHeader.appendChild(accordionButton);
                    accordionCollapse.appendChild(accordionBody);
                    accordionItem.appendChild(accordionHeader);
                    accordionItem.appendChild(accordionCollapse);
                    container.appendChild(accordionItem);
                });
            } else {
                container.innerHTML = '<p class="text-muted">Nenhuma análise encontrada.</p>';
            }

        }

        document.querySelectorAll('.btn-primary').forEach(button => {
            button.addEventListener('click', (event) => {
                const analysisId = event.target.closest('.card').querySelector('.card-header').textContent.split(': ')[1];
                const analysis = analisets.find(a => a.id == analysisId);
                showAnalysisDetails(analysis);
            });
        });



        carregarDatasets();
        carregarOpcoesDataset();

    </script>

    <script>
        document.getElementById('generateCharts').addEventListener('click', () => {
            const fileInput = document.getElementById('inputGroupFile04');

            if (!fileInput.files.length) {
                alerta("Por favor, carregue um arquivo CSV.", 'alert-warning', "alert-message-insights");
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function (event) {
                const csvData = event.target.result;
                const parsedData = parseCSV(csvData);

                // Gerar um gráfico de exemplo
                generateChart(parsedData, "calorias_tipo_treino");
            };

            reader.readAsText(file);
        });

        function parseCSV(csv) {
            const rows = csv.split("\n").map(row => row.split(","));
            const headers = rows.shift();
            return rows.map(row => {
                const obj = {};
                row.forEach((value, index) => {
                    obj[headers[index]] = isNaN(value) ? value : parseFloat(value);
                });
                return obj;
            });
        }

        function generateChart(data, insightId) {
            const ctx = document.getElementById('generateCharts').getContext('2d');
            if (insightId === "calorias_tipo_treino") {
                const workoutTypes = Array.from(new Set(data.map(row => row["workout_type"])));
                const caloriesByType = workoutTypes.map(type => {
                    return data.filter(row => row["workout_type"] === type)
                        .reduce((sum, row) => sum + row["calories_burned"], 0);
                });
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: workoutTypes,
                        datasets: [{
                            label: 'Calorias Queimadas',
                            data: caloriesByType,
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }
        }
        async function renderInsights() {
            const insights = await getInsights();
            const dropdownMenu = document.querySelector('.dropdown-menu');

            insights.insights_types.forEach(insight => {
                const listItem = document.createElement('li');
                const link = document.createElement('a');
                link.classList.add('dropdown-item');
                link.href = '#';
                link.textContent = insight.titulo;
                link.dataset.graph = insight.grafico;

                link.addEventListener('click', () => {
                    generateChartFromInsight(insight);
                });

                listItem.appendChild(link);
                dropdownMenu.appendChild(listItem);
            });
        }

        function generateChartFromInsight(insight) {
            const ctx = document.getElementById('generateCharts').getContext('2d');
            new Chart(ctx, {
                type: insight.grafico,
                data: {
                    labels: insight.labels,
                    datasets: [{
                        label: insight.titulo,
                        data: insight.dados,
                        backgroundColor: insight.cores,
                        borderColor: insight.cores,
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        renderInsights();
    </script>



</body>

</html>